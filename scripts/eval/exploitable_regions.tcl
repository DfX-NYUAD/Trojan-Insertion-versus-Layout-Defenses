# The baseline code, that is for extraction of cell placement in rows and sites, was provided as courtesy by team
# CUEDA (The Chinese University of Hong Kong; Fangzhou Wang, Qijing Wang, Bangqi Fu, Shui Jiang, Xiaopeng Zhang,
# Tsung-Yi Ho, Evangeline F.Y. Young) during ISPD'22 contest. Many thanks to them!
#
# Further edits by Johann Knechtel, NYUAD

# TODO also extract routing info; check other scripts/CUHK/scripts/ti etc
# TODO ignore TAP, FILLER cells

set outfile [open "placement.info" w+]

# extract design geometries
set core_rect [get_db designs .core_bbox]
set x_l_core [lindex $core_rect 0 0]
set y_l_core [lindex $core_rect 0 1]
set x_unit [lindex [get_db sites .size] 0 0]
set y_unit [lindex [get_db sites .size] 0 1]

puts $outfile "CORE_BBOX [lindex [get_db designs .core_bbox] 0]"
puts $outfile "NUM_ROWS [llength [get_db rows]]"
puts $outfile "NUM_SITES_PER_ROW [get_db [lindex [get_db rows] 0] .num_x]"
puts $outfile "SITE_WIDTH $x_unit "
puts $outfile "SITE_HEIGHT $y_unit "

# extract cell placement
foreach cell [get_db insts] {
	set cell_rect [lindex [get_db $cell .bbox] 0]

	set x_pos_core [expr [lindex $cell_rect 0] - $x_l_core]
	set y_pos_core [expr [lindex $cell_rect 1] - $y_l_core]
	set x_width [expr [lindex $cell_rect 2] - [lindex $cell_rect 0]]

	set x_idx [expr int(($x_pos_core + 0.001) / $x_unit)]
	set y_idx [expr int(($y_pos_core + 0.001) / $y_unit)]
	set width [expr int(($x_width + 0.001) / $x_unit)]

	puts $outfile "[get_db $cell] $x_idx $y_idx $width"
}
close $outfile

## TODO syntax for external tool call, useful for integration here, as well as for script to post-process connectivity report
set program_output [exec scripts/exploitable_regions.bin placement.info 20 | tee reports/exploitable_regions.rpt]
puts $program_output
